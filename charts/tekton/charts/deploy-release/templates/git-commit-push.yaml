apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: git-commit-push
spec:
  params:
    - name: URL
      type: string
      description: The URL of the git repository
    - name: BRANCH
      type: string
      description: The branch to push the commit to
    - name: MESSAGE
      type: string
      description: The commit message
    - name: SECRET_NAME
      type: string
      description: The name of the Kubernetes secret containing the git credentials
  workspaces:
    - name: source
      description: The workspace containing the source code to commit and push
  steps:
    - name: commit-and-push
      image: alpine/git
      workingDir: $(workspaces.source.path)
      env:
        - name: GIT_USERNAME
          valueFrom:
          secretKeyRef:
            name: $(params.SECRET_NAME)
            key: username
        - name: GIT_PASSWORD
          valueFrom:
          secretKeyRef:
            name: $(params.SECRET_NAME)
            key: password
      script: |
      #!/bin/sh
      git config --global user.email "tekton-ci@example.com"
      git config --global user.name "tekton-ci"
      
      # remove https from the URL
      URL=$(echo $(params.URL) | sed 's/^https:\/\///')
      git remote set-url origin https://$GIT_USERNAME:$GIT_PASSWORD@$URL
      
      git add .
      git commit -m "$(params.MESSAGE)"
      git push origin $(params.BRANCH)